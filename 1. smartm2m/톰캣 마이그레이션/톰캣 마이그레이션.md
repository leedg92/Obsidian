# Apache Tomcat 9.0.108 업그레이드 가이드

**CentOS 7.2.1511 + Java 8 환경**

---

## 🚨 긴급 보안 패치 필요성

- **CVE-2025-55668** (CVSS 8.8): Session Fixation 취약점
- **CVE-2025-48989** (CVSS 7.5): Resource Shutdown 취약점
- **필수 버전**: Tomcat 9.0.108 이상

---

## 📋 업그레이드 절차

### 1. 사전 백업

```bash
# 기존 Tomcat 전체 백업
sudo cp -r /opt/tomcat /backup/tomcat_backup_$(date +%Y%m%d_%H%M%S)

# 중요 설정 파일들 개별 백업
sudo cp /opt/tomcat/conf/server.xml /backup/
sudo cp /opt/tomcat/conf/web.xml /backup/
sudo cp /opt/tomcat/conf/context.xml /backup/
sudo cp -r /opt/tomcat/webapps /backup/
```

### 2. 새 버전 다운로드 및 설치

```bash
# Tomcat 9.0.108 다운로드 (보안 패치 버전)
cd /opt
sudo wget https://archive.apache.org/dist/tomcat/tomcat-9/v9.0.108/bin/apache-tomcat-9.0.108.tar.gz

# 압축 해제
sudo tar xzf apache-tomcat-9.0.108.tar.gz

# 디렉토리 이름 변경
sudo mv apache-tomcat-9.0.108 tomcat_new
```

### 3. 기존 파일들 복사

```bash
# webapps 디렉토리 (WAR 파일들)
sudo cp -r /opt/tomcat/webapps/* /opt/tomcat_new/webapps/

# conf 설정 파일들
sudo cp /opt/tomcat/conf/server.xml /opt/tomcat_new/conf/
sudo cp /opt/tomcat/conf/web.xml /opt/tomcat_new/conf/
sudo cp /opt/tomcat/conf/context.xml /opt/tomcat_new/conf/

# bin 디렉토리의 커스텀 파일들 (있다면)
sudo cp /opt/tomcat/bin/setenv.sh /opt/tomcat_new/bin/ 2>/dev/null || echo "setenv.sh not found - will create new"

# lib 디렉토리의 커스텀 라이브러리들 (있다면)
sudo cp -r /opt/tomcat/lib/* /opt/tomcat_new/lib/ 2>/dev/null || echo "No custom libs to copy"

# 소유권 설정
sudo chown -R tomcat:tomcat /opt/tomcat_new
```

### 4. setenv.sh 설정 (가장 중요!)

```bash
# setenv.sh 파일 생성/수정
sudo vi /opt/tomcat_new/bin/setenv.sh

# 다음 내용 추가 (기존 내용 아래에 추가하거나 새로 생성)
#!/bin/bash
# CentOS 7.2.1511 + Java 8 + Tomcat 9.0.108 호환성 설정

# 엔트로피 소스 설정 (RANDNUM 이슈 해결)
export JAVA_OPTS="$JAVA_OPTS -Djava.security.egd=file:/dev/./urandom"

# SSL/TLS 설정 (Java 8 호환)
export JAVA_OPTS="$JAVA_OPTS -Dhttps.protocols=TLSv1.2"
export JAVA_OPTS="$JAVA_OPTS -Djdk.tls.client.protocols=TLSv1.2"

# 실행 권한 부여
sudo chmod +x /opt/tomcat_new/bin/setenv.sh
```

### 5. 서비스 교체

```bash
# Tomcat 서비스 중지
sudo systemctl stop tomcat

# 기존 디렉토리 백업용 이름 변경
sudo mv /opt/tomcat /opt/tomcat_old

# 새 디렉토리를 실제 경로로 이동
sudo mv /opt/tomcat_new /opt/tomcat

# 서비스 시작
sudo systemctl start tomcat
```

### 6. 동작 확인

```bash
# 서비스 상태 확인
sudo systemctl status tomcat

# 로그 확인
tail -f /opt/tomcat/logs/catalina.out

# 포트 확인
netstat -tlnp | grep :8080

# HTTP 접속 테스트
curl -I http://localhost:8080/

# HTTPS 접속 테스트 (SSL 설정이 있다면)
curl -I -k https://localhost:8443/
```

---

## 🔧 필수 설정 요약

### setenv.sh에 반드시 추가할 3줄

```bash
export JAVA_OPTS="$JAVA_OPTS -Djava.security.egd=file:/dev/./urandom"
export JAVA_OPTS="$JAVA_OPTS -Dhttps.protocols=TLSv1.2"
export JAVA_OPTS="$JAVA_OPTS -Djdk.tls.client.protocols=TLSv1.2"
```

---

## ⚠️ 주의사항

1. **Java 버전**: Java 8 그대로 사용 가능
2. **setenv.sh**: 없으면 새로 생성, 있으면 위 3줄만 추가
3. **포트 설정**: 기존 포트 설정 그대로 유지
4. **방화벽**: 필요시 8080, 8443 포트 개방 확인
5. **백업**: 반드시 작업 전 백업 완료

---

## 🚑 롤백 방법 (문제 발생시)

```bash
# 서비스 중지
sudo systemctl stop tomcat

# 기존 버전으로 복구
sudo mv /opt/tomcat /opt/tomcat_failed
sudo mv /opt/tomcat_old /opt/tomcat

# 서비스 시작
sudo systemctl start tomcat
```

---

## 📞 확인 체크리스트

- [ ] 백업 완료
- [ ] Tomcat 9.0.108 다운로드
- [ ] 기존 파일들 복사 완료
- [ ] setenv.sh에 3줄 추가
- [ ] 서비스 교체 완료
- [ ] HTTP/HTTPS 접속 확인
- [ ] 웹 애플리케이션 동작 확인
- [ ] 로그 에러 없음 확인

**작업 예상 시간**: 10-15분 (다운타임 2-3분)