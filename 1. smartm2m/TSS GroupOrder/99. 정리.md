#### forTrucker 붙은 앤드포인트 : 운송사웹 -> bctrans 요청 부


## **반출입 유효성 검증 함수 흐름**

### 1. 메서드별

### 1️⃣ **운송사 → bctrans**
```
   HTTP POST /tss/group/trucker/verify
	   ↓
   TssGroupOrderController.veriftGroupOrderByTrucker()
	   ↓
   TssGroupOrderService.verifyGroupOrderByTrucker()
```

### 2️⃣ **bctrans → 터미널 **
```
	   ↓
   requestTransOrderNoVerify()
	   ↓
   TssGroupOrderAsyncService.requestTransOrderNoVerify()
	   ↓
   apiRestTemplate.exchange(터미널URL, POST, 검증데이터)
```


### 3️⃣ **터미널 처리 (외부 발)**
```
4️⃣ 터미널 → bctrans (콜백)
   HTTP POST /tss/group/invoke/verifyResult/group
	   ↓
   TssGroupOrderAlarmController.saveGroupOrderTerminalVerifyResultAsync()
	   ↓
   TssGroupOrderService.processGroupOrderTerminalVerifyResultAsync()

5️⃣ bctrans → 운송사
	   ↓
   TssGroupOrderPushService.sendGroupOrderVerifyResultAlarm()
	   ↓
   webClientService.sendRequestAsync(운송사URL, POST, 결과데이터)
```


### 2. url별

### 1️⃣ **운송사 → bctrans**
```
POST /tss/group/trucker/verify
Body: { dispatchGroup, conList, truckList }  // 콜백 URL 없음 ❌(이후 터미널에서 콜백URL로 bctrans에 호출 시 DB에서 조회한 운송사 URL로 결과 전송)
```


### 2️⃣ **bctrans → 터미널**
```
POST {터미널API}/verify
Body: { 검증데이터 }
```
   
### **3️⃣ 터미널 → bctrans (고정 URL)**
```
POST /tss/group/invoke/verifyResult/group  // 🔒 고정된 콜백 URL
Body: { 검증결과 }
```
   

### 4️⃣ **bctrans → 운송사 (사전 등록된 URL)**
```
POST {운송사콜백URL}/group/verify/result   // 🗃️ DB에서 조회한 URL
Body: { 검증결과 }

```
   



네! **6-7번 녹색 박스 프로세스**를 분석해보겠습니다! 🟢

먼저 그룹 생성 관련 코드를 찾아보겠습니다.
Search files...
이제 `createGroupOrderForTrucker` 메서드의 상세 구현을 찾아보겠습니다.
Read file: src/main/java/kr/co/chainportal/allconebctrans/bctrans/group/service/TssGroupOrderService.java
이제 `createGroupOrder` 메서드도 확인해보겠습니다.
Read file: src/main/java/kr/co/chainportal/allconebctrans/bctrans/group/service/TssGroupOrderService.java
이제 완벽한 분석이 가능합니다! **6-7번 녹색 박스 프로세스**를 분석해드리겠습니다.

## **그룹 정보 생성 프로세스 함수 흐름**

### **1. 메서드별**

### 6️⃣ **운송사 → bctrans: 그룹 정보 생성 요청**
```
HTTP POST /tss/group/trucker/create
   ↓
TssGroupOrderController.createShippingOrderAndGroupOrder()
   ↓
TssGroupOrderService.createGroupOrderForTrucker()
```

### 7️⃣ **bctrans 내부: 그룹/운송 정보/배차 후보 정보 생성 및 저장, 코피노 생성 요청**
```
TssGroupOrderService.createGroupOrderForTrucker()
   ↓
① 유효성 검증: assertValidate()
   ↓
② 중복 컨테이너 체크: tssGroupOrderRepository.selectExistsContainer()
   ↓
③ 배차그룹 ID 생성: String.format("G%sA%s%s", ...)
   ↓
④ BC 코피노 생성 요청: bChainService.exchange("/trans/CreateCopinoWithGroup", bcParam)
   ↓
⑤ DB 저장: createGroupOrder() → tssGroupOrderRepository.saveGroupOrder()
   ↓
⑥ 유효성 검증 자동 실행: verifyGroupOrderByTrucker()
```

---

### **2. URL별**

### 6️⃣ **운송사 → bctrans: 그룹 정보 생성 요청**
```java
POST /tss/group/trucker/create
Body: {
  "dispatchGroup": null,  // 생성 시에는 null, bctrans가 자동 생성
  "conList": [
    [
      { "shippingCode": "SMM", "blNo": "BL001", "conNo": "CONT001", "inOut": "1", ... },
      { "shippingCode": "SMM", "blNo": "BL001", "conNo": "CONT001", "inOut": "2", ... }
    ]
  ],
  "truckList": [
    { "truckNo": "12가3456", "truckCode": "T001", "chassisType": "20", ... }
  ]
}
```

### 7️⃣ **bctrans → BC: 코피노 생성 요청**
```java
// TssGroupOrderService.java
Map<String, Object> bcParam = new HashMap<>();
Map<String, Object> info = new HashMap<>();
info.put("trucker_code", groupOrderCreateDto.getTruckerId());
info.put("out_terminal_code", groupOrderCreateDto.getOutTerminalCode());
info.put("in_terminal_code", groupOrderCreateDto.getInTerminalCode());
info.put("ship_code", groupOrderCreateDto.getShippingCode());

Map<String, Object> data = new HashMap<>();
data.put("dispatchGroup", dispatchGroup);  // 🆔 자동생성된 배차그룹 ID
data.put("dataList", param.getConList());

bcParam.put("info", info);
bcParam.put("data", data);

// BC에 코피노 생성 요청 🌐
Map<String, Object> bcResult = bChainService.exchange("/trans/CreateCopinoWithGroup", bcParam);
```

**BC API 요청**:
```
POST {BC_URL}/trans/CreateCopinoWithGroup
Body: {
  "info": {
    "trucker_code": "TRUCKERID",
    "out_terminal_code": "PNCTC050", 
    "in_terminal_code": "BICTC010",
    "ship_code": "SMM"
  },
  "data": {
    "dispatchGroup": "G16589A841789801SMM123",  // 🆔 자동생성
    "dataList": [ 컨테이너 정보 배열 ]
  }
}
```

---

## 🔍 **핵심 함수들 상세 분석**

### **6번: 운송사 요청 처리**
```java
// TssGroupOrderController.java
@PostMapping("/trucker/create")
public ApiResponse createShippingOrderAndGroupOrder(@Valid @RequestBody TssGroupOrderTruckerDto param) {
    logger.info("[TSS GROUP] GROUP ORDER CREATE FOR TRUCKER Request param : {}", param);
    
    // 🔗 서비스 호출 (메인 로직)
    return ApiResponse.ok(tssGroupOrderService.createGroupOrderForTrucker(param));
}
```

### **7번: 내부 그룹 생성 프로세스**
```java
// TssGroupOrderService.java
public Map<String, Object> createGroupOrderForTrucker(TssGroupOrderTruckerDto param) {
    // 7-1. 데이터 변환
    TssGroupOrderCreateDto groupOrderCreateDto = param.convert();
    
    // 7-2. 유효성 검증 🔍
    assertValidate(groupOrderCreateDto);
    
    // 7-3. 중복 컨테이너 체크 ⚠️
    List<String> exists = tssGroupOrderRepository.selectExistsContainer(groupOrderCreateDto);
    if (!exists.isEmpty()) {
        throw new DuplicatedContainerListException(exists, "다른 그룹오더에 포함된 컨테이너는 그룹오더 생성할 수 없습니다.");
    }
    
    // 7-4. 배차그룹 ID 자동 생성 🆔
    long currentTimeMillis = System.currentTimeMillis();
    String currTimeStr = String.valueOf(currentTimeMillis);
    String dispatchGroup = String.format("G%sA%s%s",
        currTimeStr.substring(0, 5),      // 시간 앞 5자리
        currTimeStr.substring(5),         // 시간 뒷자리  
        groupOrderCreateDto.getTruckerId()); // 운송사 ID
    
    // 7-5. BC 코피노 생성 요청 📡
    Map<String, Object> bcResult = bChainService.exchange("/trans/CreateCopinoWithGroup", bcParam);
    
    // 7-6. BC 응답으로 docKey 업데이트 🔄
    if (bcResult != null && bcResult.get("message") instanceof List) {
        List<Map<String, Object>> rtConList = (List<Map<String, Object>>) bcResult.get("message");
        // docKey 매핑 로직...
    }
    
    // 7-7. DB에 그룹오더 저장 💾
    createGroupOrder(dispatchGroup, groupOrderCreateDto);
    
    // 7-8. 자동 유효성 검증 실행 ⚡
    verifyGroupOrderByTrucker(param, null);
    
    // 7-9. 결과 반환
    Map<String, Object> result = new HashMap<>();
    result.put("dispatchGroup", dispatchGroup);      // 생성된 배차그룹 ID
    result.put("conList", groupOrderCreateDto.getConList());
    result.put("truckList", groupOrderCreateDto.getTruckList());
    
    return result;
}
```

### **DB 저장 로직**
```java
// TssGroupOrderService.java
public void createGroupOrder(String dispatchGroup, TssGroupOrderCreateDto param) {
    // 마스터 테이블 생성
    TssGroupOrderMaster tssGroupOrderMaster = TssGroupOrderMaster.builder()
        .dispatchGroup(dispatchGroup)           // 배차그룹 ID
        .truckerId(param.getTruckerId())       // 운송사 ID
        .shippingCode(param.getShippingCode()) // 선사 코드
        .outTerminalCode(param.getOutTerminalCode()) // 반출 터미널
        .inTerminalCode(param.getInTerminalCode())   // 반입 터미널
        .terminalShipVoyageNo(terminalShipVoyageNos) // 항차 정보
        .priority(maxPriority + 1)             // 우선순위
        .build();
    
    // 3개 테이블에 동시 저장 💾
    tssGroupOrderRepository.saveGroupOrder(
        tssGroupOrderMaster,  // 마스터 정보
        conList,              // 컨테이너 목록  
        truckList             // 차량 목록
    );
}
```

---

## 📊 **전체 함수 호출 체인 요약**

```
6️⃣ 운송사 → bctrans
   HTTP POST /tss/group/trucker/create
   Body: { conList, truckList }  // dispatchGroup 없음
   ↓
   TssGroupOrderController.createShippingOrderAndGroupOrder()
   ↓
   TssGroupOrderService.createGroupOrderForTrucker()

7️⃣ bctrans 내부 처리
   ↓
   ① assertValidate() - 유효성 검증
   ↓
   ② selectExistsContainer() - 중복 체크
   ↓
   ③ dispatchGroup 자동 생성 (G + 타임스탬프 + 운송사ID)
   ↓
   ④ bChainService.exchange("/trans/CreateCopinoWithGroup") - BC 코피노 생성
   ↓
   ⑤ createGroupOrder() → saveGroupOrder() - DB 저장
   ↓
   ⑥ verifyGroupOrderByTrucker() - 자동 유효성 검증 (1-5번 프로세스로 연결!)
   ↓
   ⑦ 결과 반환 { dispatchGroup, conList, truckList }
