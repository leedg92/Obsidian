#### forTrucker ë¶™ì€ ì•¤ë“œí¬ì¸íŠ¸ : ìš´ì†¡ì‚¬ì›¹ -> bctrans ìš”ì²­ ë¶€


## **ë°˜ì¶œì… ìœ íš¨ì„± ê²€ì¦ í•¨ìˆ˜ íë¦„**

### 1. ë©”ì„œë“œë³„

### 1ï¸âƒ£ **ìš´ì†¡ì‚¬ â†’ bctrans**
```
   HTTP POST /tss/group/trucker/verify
	   â†“
   TssGroupOrderController.veriftGroupOrderByTrucker()
	   â†“
   TssGroupOrderService.verifyGroupOrderByTrucker()
```

### 2ï¸âƒ£ **bctrans â†’ í„°ë¯¸ë„ **
```
	   â†“
   requestTransOrderNoVerify()
	   â†“
   TssGroupOrderAsyncService.requestTransOrderNoVerify()
	   â†“
   apiRestTemplate.exchange(í„°ë¯¸ë„URL, POST, ê²€ì¦ë°ì´í„°)
```


### 3ï¸âƒ£ **í„°ë¯¸ë„ ì²˜ë¦¬ (ì™¸ë¶€ ë°œ)**
```
4ï¸âƒ£ í„°ë¯¸ë„ â†’ bctrans (ì½œë°±)
   HTTP POST /tss/group/invoke/verifyResult/group
	   â†“
   TssGroupOrderAlarmController.saveGroupOrderTerminalVerifyResultAsync()
	   â†“
   TssGroupOrderService.processGroupOrderTerminalVerifyResultAsync()

5ï¸âƒ£ bctrans â†’ ìš´ì†¡ì‚¬
	   â†“
   TssGroupOrderPushService.sendGroupOrderVerifyResultAlarm()
	   â†“
   webClientService.sendRequestAsync(ìš´ì†¡ì‚¬URL, POST, ê²°ê³¼ë°ì´í„°)
```


### 2. urlë³„

### 1ï¸âƒ£ **ìš´ì†¡ì‚¬ â†’ bctrans**
```
POST /tss/group/trucker/verify
Body: { dispatchGroup, conList, truckList }  // ì½œë°± URL ì—†ìŒ âŒ(ì´í›„ í„°ë¯¸ë„ì—ì„œ ì½œë°±URLë¡œ bctransì— í˜¸ì¶œ ì‹œ DBì—ì„œ ì¡°íšŒí•œ ìš´ì†¡ì‚¬ URLë¡œ ê²°ê³¼ ì „ì†¡)
```


### 2ï¸âƒ£ **bctrans â†’ í„°ë¯¸ë„**
```
POST {í„°ë¯¸ë„API}/verify
Body: { ê²€ì¦ë°ì´í„° }
```
   
### **3ï¸âƒ£ í„°ë¯¸ë„ â†’ bctrans (ê³ ì • URL)**
```
POST /tss/group/invoke/verifyResult/group  // ğŸ”’ ê³ ì •ëœ ì½œë°± URL
Body: { ê²€ì¦ê²°ê³¼ }
```
   

### 4ï¸âƒ£ **bctrans â†’ ìš´ì†¡ì‚¬ (ì‚¬ì „ ë“±ë¡ëœ URL)**
```
POST {ìš´ì†¡ì‚¬ì½œë°±URL}/group/verify/result   // ğŸ—ƒï¸ DBì—ì„œ ì¡°íšŒí•œ URL
Body: { ê²€ì¦ê²°ê³¼ }

```
   



ë„¤! **6-7ë²ˆ ë…¹ìƒ‰ ë°•ìŠ¤ í”„ë¡œì„¸ìŠ¤**ë¥¼ ë¶„ì„í•´ë³´ê² ìŠµë‹ˆë‹¤! ğŸŸ¢

ë¨¼ì € ê·¸ë£¹ ìƒì„± ê´€ë ¨ ì½”ë“œë¥¼ ì°¾ì•„ë³´ê² ìŠµë‹ˆë‹¤.
Search files...
ì´ì œ `createGroupOrderForTrucker` ë©”ì„œë“œì˜ ìƒì„¸ êµ¬í˜„ì„ ì°¾ì•„ë³´ê² ìŠµë‹ˆë‹¤.
Read file: src/main/java/kr/co/chainportal/allconebctrans/bctrans/group/service/TssGroupOrderService.java
ì´ì œ `createGroupOrder` ë©”ì„œë“œë„ í™•ì¸í•´ë³´ê² ìŠµë‹ˆë‹¤.
Read file: src/main/java/kr/co/chainportal/allconebctrans/bctrans/group/service/TssGroupOrderService.java
ì´ì œ ì™„ë²½í•œ ë¶„ì„ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤! **6-7ë²ˆ ë…¹ìƒ‰ ë°•ìŠ¤ í”„ë¡œì„¸ìŠ¤**ë¥¼ ë¶„ì„í•´ë“œë¦¬ê² ìŠµë‹ˆë‹¤.

## **ê·¸ë£¹ ì •ë³´ ìƒì„± í”„ë¡œì„¸ìŠ¤ í•¨ìˆ˜ íë¦„**

### **1. ë©”ì„œë“œë³„**

### 6ï¸âƒ£ **ìš´ì†¡ì‚¬ â†’ bctrans: ê·¸ë£¹ ì •ë³´ ìƒì„± ìš”ì²­**
```
HTTP POST /tss/group/trucker/create
   â†“
TssGroupOrderController.createShippingOrderAndGroupOrder()
   â†“
TssGroupOrderService.createGroupOrderForTrucker()
```

### 7ï¸âƒ£ **bctrans ë‚´ë¶€: ê·¸ë£¹/ìš´ì†¡ ì •ë³´/ë°°ì°¨ í›„ë³´ ì •ë³´ ìƒì„± ë° ì €ì¥, ì½”í”¼ë…¸ ìƒì„± ìš”ì²­**
```
TssGroupOrderService.createGroupOrderForTrucker()
   â†“
â‘  ìœ íš¨ì„± ê²€ì¦: assertValidate()
   â†“
â‘¡ ì¤‘ë³µ ì»¨í…Œì´ë„ˆ ì²´í¬: tssGroupOrderRepository.selectExistsContainer()
   â†“
â‘¢ ë°°ì°¨ê·¸ë£¹ ID ìƒì„±: String.format("G%sA%s%s", ...)
   â†“
â‘£ BC ì½”í”¼ë…¸ ìƒì„± ìš”ì²­: bChainService.exchange("/trans/CreateCopinoWithGroup", bcParam)
   â†“
â‘¤ DB ì €ì¥: createGroupOrder() â†’ tssGroupOrderRepository.saveGroupOrder()
   â†“
â‘¥ ìœ íš¨ì„± ê²€ì¦ ìë™ ì‹¤í–‰: verifyGroupOrderByTrucker()
```

---

### **2. URLë³„**

### 6ï¸âƒ£ **ìš´ì†¡ì‚¬ â†’ bctrans: ê·¸ë£¹ ì •ë³´ ìƒì„± ìš”ì²­**
```java
POST /tss/group/trucker/create
Body: {
  "dispatchGroup": null,  // ìƒì„± ì‹œì—ëŠ” null, bctransê°€ ìë™ ìƒì„±
  "conList": [
    [
      { "shippingCode": "SMM", "blNo": "BL001", "conNo": "CONT001", "inOut": "1", ... },
      { "shippingCode": "SMM", "blNo": "BL001", "conNo": "CONT001", "inOut": "2", ... }
    ]
  ],
  "truckList": [
    { "truckNo": "12ê°€3456", "truckCode": "T001", "chassisType": "20", ... }
  ]
}
```

### 7ï¸âƒ£ **bctrans â†’ BC: ì½”í”¼ë…¸ ìƒì„± ìš”ì²­**
```java
// TssGroupOrderService.java
Map<String, Object> bcParam = new HashMap<>();
Map<String, Object> info = new HashMap<>();
info.put("trucker_code", groupOrderCreateDto.getTruckerId());
info.put("out_terminal_code", groupOrderCreateDto.getOutTerminalCode());
info.put("in_terminal_code", groupOrderCreateDto.getInTerminalCode());
info.put("ship_code", groupOrderCreateDto.getShippingCode());

Map<String, Object> data = new HashMap<>();
data.put("dispatchGroup", dispatchGroup);  // ğŸ†” ìë™ìƒì„±ëœ ë°°ì°¨ê·¸ë£¹ ID
data.put("dataList", param.getConList());

bcParam.put("info", info);
bcParam.put("data", data);

// BCì— ì½”í”¼ë…¸ ìƒì„± ìš”ì²­ ğŸŒ
Map<String, Object> bcResult = bChainService.exchange("/trans/CreateCopinoWithGroup", bcParam);
```

**BC API ìš”ì²­**:
```
POST {BC_URL}/trans/CreateCopinoWithGroup
Body: {
  "info": {
    "trucker_code": "TRUCKERID",
    "out_terminal_code": "PNCTC050", 
    "in_terminal_code": "BICTC010",
    "ship_code": "SMM"
  },
  "data": {
    "dispatchGroup": "G16589A841789801SMM123",  // ğŸ†” ìë™ìƒì„±
    "dataList": [ ì»¨í…Œì´ë„ˆ ì •ë³´ ë°°ì—´ ]
  }
}
```

---

## ğŸ” **í•µì‹¬ í•¨ìˆ˜ë“¤ ìƒì„¸ ë¶„ì„**

### **6ë²ˆ: ìš´ì†¡ì‚¬ ìš”ì²­ ì²˜ë¦¬**
```java
// TssGroupOrderController.java
@PostMapping("/trucker/create")
public ApiResponse createShippingOrderAndGroupOrder(@Valid @RequestBody TssGroupOrderTruckerDto param) {
    logger.info("[TSS GROUP] GROUP ORDER CREATE FOR TRUCKER Request param : {}", param);
    
    // ğŸ”— ì„œë¹„ìŠ¤ í˜¸ì¶œ (ë©”ì¸ ë¡œì§)
    return ApiResponse.ok(tssGroupOrderService.createGroupOrderForTrucker(param));
}
```

### **7ë²ˆ: ë‚´ë¶€ ê·¸ë£¹ ìƒì„± í”„ë¡œì„¸ìŠ¤**
```java
// TssGroupOrderService.java
public Map<String, Object> createGroupOrderForTrucker(TssGroupOrderTruckerDto param) {
    // 7-1. ë°ì´í„° ë³€í™˜
    TssGroupOrderCreateDto groupOrderCreateDto = param.convert();
    
    // 7-2. ìœ íš¨ì„± ê²€ì¦ ğŸ”
    assertValidate(groupOrderCreateDto);
    
    // 7-3. ì¤‘ë³µ ì»¨í…Œì´ë„ˆ ì²´í¬ âš ï¸
    List<String> exists = tssGroupOrderRepository.selectExistsContainer(groupOrderCreateDto);
    if (!exists.isEmpty()) {
        throw new DuplicatedContainerListException(exists, "ë‹¤ë¥¸ ê·¸ë£¹ì˜¤ë”ì— í¬í•¨ëœ ì»¨í…Œì´ë„ˆëŠ” ê·¸ë£¹ì˜¤ë” ìƒì„±í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
    }
    
    // 7-4. ë°°ì°¨ê·¸ë£¹ ID ìë™ ìƒì„± ğŸ†”
    long currentTimeMillis = System.currentTimeMillis();
    String currTimeStr = String.valueOf(currentTimeMillis);
    String dispatchGroup = String.format("G%sA%s%s",
        currTimeStr.substring(0, 5),      // ì‹œê°„ ì• 5ìë¦¬
        currTimeStr.substring(5),         // ì‹œê°„ ë’·ìë¦¬  
        groupOrderCreateDto.getTruckerId()); // ìš´ì†¡ì‚¬ ID
    
    // 7-5. BC ì½”í”¼ë…¸ ìƒì„± ìš”ì²­ ğŸ“¡
    Map<String, Object> bcResult = bChainService.exchange("/trans/CreateCopinoWithGroup", bcParam);
    
    // 7-6. BC ì‘ë‹µìœ¼ë¡œ docKey ì—…ë°ì´íŠ¸ ğŸ”„
    if (bcResult != null && bcResult.get("message") instanceof List) {
        List<Map<String, Object>> rtConList = (List<Map<String, Object>>) bcResult.get("message");
        // docKey ë§¤í•‘ ë¡œì§...
    }
    
    // 7-7. DBì— ê·¸ë£¹ì˜¤ë” ì €ì¥ ğŸ’¾
    createGroupOrder(dispatchGroup, groupOrderCreateDto);
    
    // 7-8. ìë™ ìœ íš¨ì„± ê²€ì¦ ì‹¤í–‰ âš¡
    verifyGroupOrderByTrucker(param, null);
    
    // 7-9. ê²°ê³¼ ë°˜í™˜
    Map<String, Object> result = new HashMap<>();
    result.put("dispatchGroup", dispatchGroup);      // ìƒì„±ëœ ë°°ì°¨ê·¸ë£¹ ID
    result.put("conList", groupOrderCreateDto.getConList());
    result.put("truckList", groupOrderCreateDto.getTruckList());
    
    return result;
}
```

### **DB ì €ì¥ ë¡œì§**
```java
// TssGroupOrderService.java
public void createGroupOrder(String dispatchGroup, TssGroupOrderCreateDto param) {
    // ë§ˆìŠ¤í„° í…Œì´ë¸” ìƒì„±
    TssGroupOrderMaster tssGroupOrderMaster = TssGroupOrderMaster.builder()
        .dispatchGroup(dispatchGroup)           // ë°°ì°¨ê·¸ë£¹ ID
        .truckerId(param.getTruckerId())       // ìš´ì†¡ì‚¬ ID
        .shippingCode(param.getShippingCode()) // ì„ ì‚¬ ì½”ë“œ
        .outTerminalCode(param.getOutTerminalCode()) // ë°˜ì¶œ í„°ë¯¸ë„
        .inTerminalCode(param.getInTerminalCode())   // ë°˜ì… í„°ë¯¸ë„
        .terminalShipVoyageNo(terminalShipVoyageNos) // í•­ì°¨ ì •ë³´
        .priority(maxPriority + 1)             // ìš°ì„ ìˆœìœ„
        .build();
    
    // 3ê°œ í…Œì´ë¸”ì— ë™ì‹œ ì €ì¥ ğŸ’¾
    tssGroupOrderRepository.saveGroupOrder(
        tssGroupOrderMaster,  // ë§ˆìŠ¤í„° ì •ë³´
        conList,              // ì»¨í…Œì´ë„ˆ ëª©ë¡  
        truckList             // ì°¨ëŸ‰ ëª©ë¡
    );
}
```

---

## ğŸ“Š **ì „ì²´ í•¨ìˆ˜ í˜¸ì¶œ ì²´ì¸ ìš”ì•½**

```
6ï¸âƒ£ ìš´ì†¡ì‚¬ â†’ bctrans
   HTTP POST /tss/group/trucker/create
   Body: { conList, truckList }  // dispatchGroup ì—†ìŒ
   â†“
   TssGroupOrderController.createShippingOrderAndGroupOrder()
   â†“
   TssGroupOrderService.createGroupOrderForTrucker()

7ï¸âƒ£ bctrans ë‚´ë¶€ ì²˜ë¦¬
   â†“
   â‘  assertValidate() - ìœ íš¨ì„± ê²€ì¦
   â†“
   â‘¡ selectExistsContainer() - ì¤‘ë³µ ì²´í¬
   â†“
   â‘¢ dispatchGroup ìë™ ìƒì„± (G + íƒ€ì„ìŠ¤íƒ¬í”„ + ìš´ì†¡ì‚¬ID)
   â†“
   â‘£ bChainService.exchange("/trans/CreateCopinoWithGroup") - BC ì½”í”¼ë…¸ ìƒì„±
   â†“
   â‘¤ createGroupOrder() â†’ saveGroupOrder() - DB ì €ì¥
   â†“
   â‘¥ verifyGroupOrderByTrucker() - ìë™ ìœ íš¨ì„± ê²€ì¦ (1-5ë²ˆ í”„ë¡œì„¸ìŠ¤ë¡œ ì—°ê²°!)
   â†“
   â‘¦ ê²°ê³¼ ë°˜í™˜ { dispatchGroup, conList, truckList }
