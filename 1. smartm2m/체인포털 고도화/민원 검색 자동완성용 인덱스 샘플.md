-- ========================================
-- 1. B-tree 인덱스 생성 (LIKE 검색용)
-- ========================================
ALTER TABLE t_complaint 
ADD INDEX idx_truck_no (complainant_truck_no);

ALTER TABLE t_complaint 
ADD INDEX idx_container_no (complainant_con_no);

ALTER TABLE t_complaint 
ADD INDEX idx_title (complaint_title(100));

-- 인덱스 확인
SHOW INDEX FROM t_complaint 
WHERE Key_name LIKE 'idx_%';

-- ========================================
-- 2. 테스트 - 차량번호 자동완성
-- ========================================
-- 2-1) 기본 검색
SELECT DISTINCT 
  complainant_truck_no as value,
  COUNT(*) OVER (PARTITION BY complainant_truck_no) as usage_count
FROM t_complaint
WHERE complainant_truck_no LIKE '부산99%'
  AND complainant_truck_no IS NOT NULL
ORDER BY usage_count DESC
LIMIT 10;

-- 2-2) 성능 확인
EXPLAIN
SELECT complainant_truck_no
FROM t_complaint
WHERE complainant_truck_no LIKE '부산99%';
-- "range" 타입이 나오면 인덱스 사용 중

-- ========================================
-- 3. 테스트 - 컨테이너 번호 자동완성
-- ========================================
SELECT DISTINCT 
  complainant_con_no as value,
  COUNT(*) as usage_count
FROM t_complaint
WHERE complainant_con_no LIKE 'SKHU%'
  AND complainant_con_no IS NOT NULL
GROUP BY complainant_con_no
ORDER BY usage_count DESC
LIMIT 10;

-- ========================================
-- 4. 테스트 - 제목 검색 (포함)
-- ========================================
SELECT 
  complaint_id,
  complaint_title,
  complaint_date
FROM t_complaint
WHERE complaint_title LIKE '%인수도증%'
ORDER BY complaint_date DESC
LIMIT 10;

-- ========================================
-- 5. 테스트 - 통합 자동완성 (실전용!)
-- ========================================
(
  -- 차량번호
  SELECT 
    'truck' as type,
    complainant_truck_no as value,
    complainant_truck_no as display,
    COUNT(*) as cnt
  FROM t_complaint
  WHERE complainant_truck_no LIKE 'SKH%'
    AND complainant_truck_no IS NOT NULL
  GROUP BY complainant_truck_no
  ORDER BY cnt DESC
  LIMIT 5
)
UNION ALL
(
  -- 컨테이너 번호
  SELECT 
    'container' as type,
    complainant_con_no as value,
    complainant_con_no as display,
    COUNT(*) as cnt
  FROM t_complaint
  WHERE complainant_con_no LIKE 'SKH%'
    AND complainant_con_no IS NOT NULL
  GROUP BY complainant_con_no
  ORDER BY cnt DESC
  LIMIT 5
)
UNION ALL
(
  -- 제목 (최근순)
  SELECT 
    'title' as type,
    complaint_title as value,
    LEFT(complaint_title, 50) as display,
    1 as cnt
  FROM t_complaint
  WHERE complaint_title LIKE 'SKH%'
    AND complaint_title IS NOT NULL
  ORDER BY complaint_date DESC
  LIMIT 5
)
ORDER BY type, cnt DESC;

-- ========================================
-- 6. 테스트 - 터미널 검색
-- ========================================
SELECT 
  complaint_id,
  target_terminal,
  complaint_title,
  complaint_date
FROM t_complaint
WHERE target_terminal = 'BPTS'
   OR complaint_title LIKE '%BPTS%'
   OR complaint_content LIKE '%BPTS%'
ORDER BY complaint_date DESC
LIMIT 10;

-- ========================================
-- 7. 성능 비교 - 인덱스 있을 때 vs 없을 때
-- ========================================
-- 인덱스 사용
EXPLAIN
SELECT complainant_truck_no
FROM t_complaint
WHERE complainant_truck_no LIKE '부산%';

-- 인덱스 강제 무시 (비교용)
EXPLAIN
SELECT complainant_truck_no
FROM t_complaint IGNORE INDEX (idx_truck_no)
WHERE complainant_truck_no LIKE '부산%';

-- ========================================
-- 8. 실행 시간 측정
-- ========================================
SET profiling = 1;

-- 테스트 쿼리 실행
SELECT COUNT(DISTINCT complainant_truck_no)
FROM t_complaint
WHERE complainant_truck_no LIKE '부산%';

-- 결과 확인
SHOW PROFILES;

SET profiling = 0;

-- ========================================
-- 9. 인덱스 삭제
-- ========================================
ALTER TABLE t_complaint DROP INDEX idx_truck_no;
ALTER TABLE t_complaint DROP INDEX idx_container_no;
ALTER TABLE t_complaint DROP INDEX idx_title;

-- 삭제 확인
SHOW INDEX FROM t_complaint 
WHERE Key_name LIKE 'idx_%';