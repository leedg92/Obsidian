# 1.1. 모듈별 상세 설계

## 1.1.1. 서버 리소스 모니터링 모듈

### 1. 모듈 개요

|항목|내용|
|---|---|
|**모듈명**|서버 리소스 모니터링 모듈|
|**목적**|터미널별 서버 리소스 상태 실시간 모니터링 및 데이터 관리|
|**주요 기능**|• 5분 주기 헬스체크 수행<br>• 4가지 메트릭 수집 (Memory, Threads, Deadlocks, Health)<br>• 주간 데이터 아카이빙<br>• 관제시스템 API 제공|
|**기술 스택**|Spring Boot, MariaDB, Scheduler|

### 2. 아키텍처 설계

#### 2.1 계층 구조

```
┌─────────────────────────────────────┐
│           Presentation Layer        │  ← Controller (API)
├─────────────────────────────────────┤
│           Business Layer            │  ← Service (비즈니스 로직)
├─────────────────────────────────────┤
│           Data Access Layer         │  ← Repository (데이터 접근)
├─────────────────────────────────────┤
│           Infrastructure Layer      │  ← 외부 API, Scheduler
└─────────────────────────────────────┘
```

#### 2.2 컴포넌트 구성도

```
┌──────────────────┐    ┌──────────────────┐    ┌──────────────────┐
│   Scheduler      │───▶│  HealthCheck     │───▶│  Metric Data     │
│   Component      │    │  Service         │    │  Service         │
└──────────────────┘    └──────────────────┘    └──────────────────┘
                                │                        │
┌──────────────────┐    ┌──────────────────┐    ┌──────────────────┐
│   Archive        │◀───│  Terminal        │───▶│  HTTP Client     │
│   Service        │    │  Processor       │    │  Service         │
└──────────────────┘    └──────────────────┘    └──────────────────┘
```

### 3. 클래스 다이어그램

```mermaid
classDiagram
    %% Controller Layer
    class HealthCheckController {
        +getTerminalStatus(terminalName: String): ResponseEntity
        +executeManualCheck(terminalName: String): ResponseEntity
        +triggerArchive(): ResponseEntity
        +getMonitoringStats(): ResponseEntity
    }

    %% Service Layer (비즈니스 로직)
    class HealthCheckService {
        -schedulerService: SchedulerService
        -terminalProcessor: TerminalProcessorService
        -metricDataService: MetricDataService
        +performScheduledCheck(): void
        +executeHealthCheck(terminal: String): HealthCheckResult
        +aggregateMetrics(results: List): MetricSummary
        +validateConfiguration(): boolean
    }

    class TerminalProcessorService {
        -httpClientService: HttpClientService
        -endpointConfigService: EndpointConfigService
        +processTerminalMetrics(terminal: String): CompletableFuture
        +executeParallelCalls(endpoints: List): Map
        +handleAPIFailure(error: Exception): ErrorMetric
        +validateResponse(response: ApiResponse): boolean
    }

    class MetricDataService {
        -memoryRepository: MemoryRepository
        -threadRepository: ThreadRepository
        -deadlockRepository: DeadlockRepository
        -statusRepository: StatusRepository
        +saveMetricData(metric: Metric): void
        +getLatestMetrics(terminal: String): MetricSummary
        +getMetricsForPeriod(period: DateRange): List
        +validateMetricData(data: Object): boolean
    }

    class ArchiveService {
        -fileSystemService: FileSystemService
        -compressionService: CompressionService
        +performWeeklyArchive(): ArchiveResult
        +archiveMetricsByType(type: MetricType): void
        +compressAndStore(data: byte[]): String
        +cleanupOldData(cutoffDate: Date): void
    }

    class EndpointConfigService {
        -endpointRepository: EndpointRepository
        +getActiveEndpoints(): List
        +getEndpointsByTerminal(terminal: String): List
        +validateEndpointConfig(config: EndpointConfig): boolean
        +updateEndpointStatus(endpoint: String, status: boolean): void
    }

    %% Infrastructure Layer
    class HttpClientService {
        +callMetricAPI(endpoint: EndpointInfo): ApiResponse
        +executeWithRetry(request: ApiRequest): ApiResponse
        +handleTimeout(request: ApiRequest): ApiResponse
        +validateConnection(url: String): boolean
    }

    class SchedulerService {
        +scheduleHealthCheck(): void
        +scheduleArchiving(): void
        +pauseScheduler(): void
        +resumeScheduler(): void
        +getScheduleStatus(): ScheduleInfo
    }

    %% Relationships
    HealthCheckController --> HealthCheckService
    HealthCheckService --> TerminalProcessorService
    HealthCheckService --> MetricDataService
    HealthCheckService --> ArchiveService
    TerminalProcessorService --> HttpClientService
    TerminalProcessorService --> EndpointConfigService
    SchedulerService --> HealthCheckService
```

### 4. 시퀀스 다이어그램

#### 4.1 5분 주기 헬스체크 실행

```mermaid
sequenceDiagram
    participant Scheduler as SchedulerService
    participant HealthSvc as HealthCheckService  
    participant TerminalProc as TerminalProcessorService
    participant EndpointSvc as EndpointConfigService
    participant HttpClient as HttpClientService
    participant MetricData as MetricDataService

    Note over Scheduler: 5분마다 실행
    Scheduler->>HealthSvc: performScheduledCheck()
    
    HealthSvc->>EndpointSvc: getActiveEndpoints()
    EndpointSvc-->>HealthSvc: List<EndpointInfo>
    
    loop 각 터미널별
        HealthSvc->>TerminalProc: processTerminalMetrics(terminalName)
        
        par 4가지 메트릭 병렬 수집
            TerminalProc->>HttpClient: callMetricAPI(memoryEndpoint)
            HttpClient-->>TerminalProc: MemoryResponse
        and
            TerminalProc->>HttpClient: callMetricAPI(threadsEndpoint)  
            HttpClient-->>TerminalProc: ThreadsResponse
        and
            TerminalProc->>HttpClient: callMetricAPI(deadlocksEndpoint)
            HttpClient-->>TerminalProc: DeadlocksResponse
        and
            TerminalProc->>HttpClient: callMetricAPI(healthEndpoint)
            HttpClient-->>TerminalProc: HealthResponse
        end
        
        TerminalProc->>MetricData: saveMetricData(collectedMetrics)
        MetricData-->>TerminalProc: SaveResult
        
        TerminalProc-->>HealthSvc: CompletableFuture<MetricResult>
    end
    
    HealthSvc->>HealthSvc: aggregateMetrics(allResults)
    HealthSvc-->>Scheduler: HealthCheckComplete
```

#### 4.2 주간 아카이브 실행

```mermaid
sequenceDiagram
    participant Scheduler as SchedulerService
    participant Archive as ArchiveService
    participant MetricData as MetricDataService
    participant FileSystem as FileSystemService
    participant Compression as CompressionService

    Note over Scheduler: 매주 일요일 자정
    Scheduler->>Archive: performWeeklyArchive()
    
    loop 4가지 메트릭 타입
        Archive->>MetricData: getMetricsForPeriod(lastWeek, metricType)
        MetricData-->>Archive: List<MetricData>
        
        Archive->>Archive: convertToJSON(metricData)
        Archive->>Compression: compressData(jsonData)
        Compression-->>Archive: compressedData
        
        Archive->>FileSystem: saveArchiveFile(fileName, compressedData)
        FileSystem-->>Archive: filePath
        
        Archive->>MetricData: deleteOldData(lastWeek, metricType)
        MetricData-->>Archive: deleteCount
    end
    
    Archive-->>Scheduler: ArchiveResult
```

#### 4.3 관제시스템 API 호출

```mermaid
sequenceDiagram
    participant Client as 관제시스템
    participant Controller as HealthCheckController
    participant HealthSvc as HealthCheckService
    participant MetricData as MetricDataService

    Client->>Controller: GET /api/terminal/{name}/status
    Controller->>MetricData: getLatestMetrics(terminalName)
    MetricData-->>Controller: MetricSummary
    Controller-->>Client: ResponseEntity<MetricSummary>

    Client->>Controller: POST /api/terminal/{name}/check
    Controller->>HealthSvc: executeHealthCheck(terminalName)
    HealthSvc->>HealthSvc: performImmediateCheck()
    HealthSvc-->>Controller: HealthCheckResult
    Controller-->>Client: ResponseEntity<HealthCheckResult>
```

### 5. 데이터 흐름도

```
터미널 API ──┐
             ├─► TerminalProcessor ──► MetricDataService ──► Database
터미널 API ──┘                                              │
                                                            ▼
SchedulerService ──► ArchiveService ──────────────────► File System
                                                            │
관제시스템 ◄─── HealthCheckController ◄─────────────────────┘
```