# 레거시 코드 리팩토링 분석 문서

## 1. 개요

DR(재해복구) 대응을 위한 레거시 백엔드 코드 리팩토링 분석 문서입니다.
전송 목적지 변경에 따라 새로운 인터페이스 명세에 맞게 구조를 정리하는 작업입니다.

---

## 2. 리팩토링 구조 (kakaoAgent 패키지)

### 2.1 전체 흐름

```
MQ 메시지 수신
    ↓
Listener (메시지 타입별 Handler 분기)
    ↓
Handler (오케스트레이터)
    ├── HMM 프로그램 최초 호출 → 리스트 반환
    └── 리스트 루프 (건별 처리)
            ├── Integrator: 데이터 통합/정제 (조건에 따라 HMM 추가 호출)
            ├── Adapter: 목적지 인터페이스에 맞게 DTO 조립
            └── Sender: 데이터 전송
                    └── 실패 시 로깅 후 다음 루프 진행
```

### 2.2 컴포넌트 역할

| 컴포넌트 | 역할 |
|---------|------|
| **Handler** | 메시지 타입별 분기, 전체 흐름 제어, HMM 최초 호출 |
| **Integrator** | 데이터 통합/정제, 조건에 따라 HMM 추가 호출 |
| **Adapter** | 목적지 인터페이스 명세에 맞게 DTO 조립 |
| **Sender** | 완성된 DTO를 목적지로 전송 |

### 2.3 설계 의도

- **Integrator에서 변경 지점 격리**: 명세 미확정 상황 대응, 확정 시 Integrator만 수정
- **목적지 변경 대응**: Kakao → 다른 곳으로 변경 시 Sender, Integrator, Adapter만 교체

---

## 3. 메시지 타입 분류

### 3.1 MQ 메시지 식별자

```java
if (StringUtils.contains(text, "JB↔CFM↔↔↔")      // 상하차 (작업완료)
    || (StringUtils.contains(text, "GT↔MSG↔"))    // 게이트 (GI/GO/GX/ER)
    || (StringUtils.contains(text, "CO↔MSG↔"))    // COPINO 검증
    || (StringUtils.contains(text, "BLKEN"))      // 블록진입
    || (StringUtils.contains(text, "CHGLOC"))     // 작업위치변경
    || (StringUtils.contains(text, "EMTSWP"))     // 공컨교체
    || (StringUtils.contains(text, "RF↔MSG"))     // 냉컨플러그아웃
    || (StringUtils.contains(text, "CD↔MSG"))     // 코피노 삭제
    || (StringUtils.contains(text, "NONLOC↔MSG")) // 장치 위치 없음
)
```

### 3.2 메시지 타입 매핑

| 메시지 식별자 | 메시지 타입 | 레거시 서비스 | 리팩토링 상태 |
|--------------|------------|--------------|--------------|
| `CO↔MSG↔` | 코피노 검증 (copinoVerification) | VbsCopinoVerificationService | ✅ 완료 |
| `CD↔MSG↔` | 코피노 삭제 (copinoDelete) | VbsCopinoRemoveService | ✅ 완료 |
| `GT↔MSG↔` (GI/GX) | 게이트 진입 (gateIn) | VbsGateInService | 🔄 진행중 |
| `GT↔MSG↔` (GO) | 게이트 아웃 (gateOut) | VbsGateOutService | ⬜ 미시작 |
| `GT↔MSG↔` (ER) | 게이트 에러 (gateError) | VbsGateInService / VbsGateOutService | ⬜ 미시작 |
| `BLKEN` | 블록 진입 (blockIn) | VbsBlockInService | ⬜ 미시작 |
| `JB↔CFM↔↔↔` | 작업완료 (jobDone) | VbsJobDoneService | ⬜ 미시작 |
| `CHGLOC↔MSG` | 작업위치변경 (conLocationChange) | VbsEmptyConMoveService | ⬜ 미시작 |
| `EMTSWP↔MSG` | 공컨교체 (emptyConSwap) | VbsEmptyConSwapService | ⬜ 미시작 |
| `RF↔MSG` | 냉컨플러그아웃 (reeferPlugInOut) | VbsReeferService | ⬜ 미시작 |
| `NONLOC↔MSG` | 장치 위치 없음 (nonConLocation) | VbsEmptyConMoveService | ⬜ 미시작 |

---

## 4. 서비스 내부 호출 관계

### 4.1 직접 호출 (BpaBusinessService에서)

| 메시지 타입 | 호출되는 서비스 |
|------------|----------------|
| 코피노 검증 | VbsCopinoVerificationService |
| 코피노 삭제 | VbsCopinoRemoveService |
| 게이트 진입/에러 | VbsGateInService |
| 게이트 아웃 | VbsGateOutService, VbsCancelGateService |
| 블록 진입 | VbsBlockInService |
| 작업완료 | VbsJobDoneService |
| 작업위치변경 | VbsEmptyConMoveService |
| 공컨교체 | VbsEmptyConSwapService |
| 냉컨플러그아웃 | VbsReeferService |

### 4.2 내부 호출 (서비스 간)

| 호출하는 서비스 | 호출되는 서비스 | 호출 조건 |
|----------------|----------------|----------|
| VbsGateOutService | VbsTransStatusService | GateOut 성공 후 완료상태 저장 |
| VbsCancelGateService | VbsGateOutService | CancelGate 처리 후 GateOut 호출 |
| VbsCopinoRemoveService | VbsReservationService | @Autowired만 있고 실제 미사용 |

### 4.3 별도 진입점 서비스

| 서비스 | 용도 |
|--------|------|
| VbsTransOrderService | B/C에서 TransOrder 수신 및 검증 (별도 API 엔드포인트) |
| VbsReservationService | 예약 관련 처리 (별도 API 엔드포인트) |

---

## 5. 메시지별 HMM 호출 분석

### 5.1 CO↔MSG↔ (코피노 검증) ✅ 리팩토링 완료

| 구분 | HMM Program ID | 설명 |
|------|----------------|------|
| **최초 호출** | `API-BPA-BCITT-S-GETCOPINOINFO` | MSG_SEQ로 코피노 정보 조회 |
| **조건부 호출** | `API-BPA-INFO-S-GETRFCNTRPLUGORD` | 컨테이너번호가 ZZZZ/EMPTY/M001/HMMU0000000이 아닌 경우 냉동컨테이너 플러그 상태 조회 |

**처리 흐름:**
```
processCopinoVerification(msgSeq, statusCode, msg)
    ↓
API-BPA-BCITT-S-GETCOPINOINFO (MSG_SEQ로 조회)
    ↓
list.forEach → VbsCopinoVerificationService.processCopinoVerification()
    ↓
[조건부] API-BPA-INFO-S-GETRFCNTRPLUGORD (정상 컨테이너번호인 경우)
    ↓
vbsBChainService.exchange("/vbs/terminal/CopinoVerificationResult")
```

---

### 5.2 CD↔MSG↔ (코피노 삭제) ✅ 리팩토링 완료

| 구분 | HMM Program ID | 설명 |
|------|----------------|------|
| **최초 호출** | `API-BPA-BCITT-S-GETCOPINOINFO` | MSG_SEQ로 코피노 정보 조회 |
| **조건부 호출** | `API-BPA-BCITT-S-GETPINNO` | DOC_KEY로 PIN_NO 조회 |

**처리 흐름:**
```
processCopinoDelete(tmnCode, issueSeq, msgSeq)
    ↓
API-BPA-BCITT-S-GETCOPINOINFO (MSG_SEQ로 조회)
    ↓
list.forEach → VbsCopinoRemoveService.processCopinoRemove()
    ↓
API-BPA-BCITT-S-GETPINNO (PIN_NO 조회)
    ↓
vbsBChainService.exchange("/vbs/terminal/RemoveCopino")
    ↓
API-BPA-BCITT-S-CRTAPPMNTMST (마스터 DB 업데이트)
```

---

### 5.3 GT↔MSG↔ - GI/GX (게이트 진입)

| 구분 | HMM Program ID | 설명 |
|------|----------------|------|
| **최초 호출** | `HITOPS3-WEB-BLK-S-GETITTINFOBYEIRNO` | EIR_NO로 ITT 정보 조회 |
| **조건부 호출** | `API-BPA-BCITT-S-GETBLOCKNUMBYTRKNO` | 블록 대기 차량 수 조회 |
| **누락 예외처리** | `HITOPS3-GTE-CTL-S-LSTXTCURRWORKSTATUS` | PIN_NO 누락 시 조회 |
| **누락 예외처리** | `API-BPA-BCITT-S-GETPINNO` | PIN_NO 조회 |

**처리 흐름:**
```
processGate(sEirNo, sMsgCod, sMsgDate)
    ↓
HITOPS3-WEB-BLK-S-GETITTINFOBYEIRNO (EIR_NO로 조회)
    ↓
list.forEach → VbsGateInService.processGateIn()
    ↓
API-BPA-BCITT-S-GETBLOCKNUMBYTRKNO (블록 대기 차량 수)
    ↓
vbsBChainService.exchange("/vbs/terminal/GateIn")
    ↓
API-BPA-BCITT-S-CRTAPPMNTMST (마스터 DB 업데이트)
```

---

### 5.4 GT↔MSG↔ - GO (게이트 아웃)

| 구분 | HMM Program ID | 설명 |
|------|----------------|------|
| **최초 호출** | `HITOPS3-WEB-BLK-S-GETITTINFOBYEIRNO2` | EIR_NO로 ITT 정보 조회 (GateOut용) |
| **완료상태 저장** | `HITOPS3-WEB-BLK-S-CRTTRKDSTINFO` | 운송 완료상태 저장 |

**처리 흐름 (CNL_TAG 분기):**
```
processGateOut(sEirNo, sMsgCod, sMsgDate)
    ↓
HITOPS3-WEB-BLK-S-GETITTINFOBYEIRNO2 (EIR_NO로 조회)
    ↓
[분기] CNL_TAG=Y && XRAY=Y
    └─ VbsCancelGateService.processCancelGate()
           ↓
       vbsBChainService.exchange("/vbs/terminal/CancelInOut")
           ↓
       VbsGateOutService.processGateOut() (내부 호출)

[분기] CNL_TAG=Y && XRAY=N
    └─ VbsCancelGateService.processCancelGate()
           ↓
       VbsGateOutService.processGateOut()
           ↓
       vbsBChainService.exchange("/vbs/terminal/GateOut")
           ↓
       VbsTransStatusService.saveTransStatus() (COMPLETE 상태)
           ↓
       HITOPS3-WEB-BLK-S-CRTTRKDSTINFO

[분기] else (일반 GateOut)
    └─ VbsGateOutService.processGateOut()
           ↓
       vbsBChainService.exchange("/vbs/terminal/GateOut")
           ↓
       VbsTransStatusService.saveTransStatus() (COMPLETE 상태)
```

---

### 5.5 GT↔MSG↔ - ER (게이트 에러)

| 구분 | HMM Program ID | 설명 |
|------|----------------|------|
| **최초 호출** | `HITOPS3-WEB-BLK-S-GETITTINFOBYTRKNO` | TRK_NO로 ITT 정보 조회 |

**처리 흐름:**
```
processGateError(sTrkNo, sEirNo, sMsgDate, sLaneNo)
    ↓
HITOPS3-WEB-BLK-S-GETITTINFOBYTRKNO (TRK_NO로 조회)
    ↓
[분기] sLaneNo.contains("I")
    └─ VbsGateInService.processGateIn() (GateIn과 동일)

[분기] sLaneNo.contains("O")
    └─ VbsGateOutService.processGateOut() (GateOut과 동일)
```

---

### 5.6 BLKEN (블록 진입)

| 구분 | HMM Program ID | 설명 |
|------|----------------|------|
| **최초 호출** | `HITOPS3-GTE-CMN-S-GETTRKBLKENTER` | JOB_SEQ로 블록 진입 정보 조회 |
| **조건부 호출** | `API-BPA-BCITT-S-GETBLOCKNUMBYTRKNO` | 블록 대기 차량 수 조회 |
| **누락 예외처리** | `HITOPS3-WEB-BLK-S-GETITTINFOBYTRKNO` | TRK_CO/CNTR_OPR 누락 시 |
| **누락 예외처리** | `HITOPS3-WEB-BLK-S-GETITTINFOBYEIRNO` | TRK_CO/CNTR_OPR 누락 시 |

**처리 흐름:**
```
processBlockIn(sJobSeq)
    ↓
HITOPS3-GTE-CMN-S-GETTRKBLKENTER (JOB_SEQ로 조회)
    ↓
list.forEach → VbsBlockInService.processBlockIn()
    ↓
[조건부] TRK_CO/CNTR_OPR 누락 시
    └─ HITOPS3-WEB-BLK-S-GETITTINFOBYTRKNO 또는 GETITTINFOBYEIRNO
    ↓
API-BPA-BCITT-S-GETBLOCKNUMBYTRKNO (블록 대기 차량 수)
    ↓
vbsBChainService.exchange("/vbs/terminal/EnterBlock")
```

---

### 5.7 JB↔CFM↔↔↔ (작업완료)

| 구분 | HMM Program ID | 설명 |
|------|----------------|------|
| **최초 호출** | `HITOPS3-WEB-BLK-S-GETITTINFOBYJOBSEQ` | JOB_SEQ로 ITT 정보 조회 |

**처리 흐름:**
```
processJobDone(sJobSeq)
    ↓
HITOPS3-WEB-BLK-S-GETITTINFOBYJOBSEQ (JOB_SEQ로 조회)
    ↓
list.forEach → VbsJobDoneService.processJobDone()
    ↓
[조건부] M2Block (4M1/4M2로 시작하는 위치)
    └─ vbsBChainService.exchange("/vbs/terminal/EmptyConSwapResult")
    ↓
vbsBChainService.exchange("/vbs/terminal/JobDone")
    ↓
API-BPA-BCITT-S-CRTAPPMNTMST (마스터 DB 업데이트)
```

---

### 5.8 CHGLOC↔MSG (작업위치변경)

| 구분 | HMM Program ID | 설명 |
|------|----------------|------|
| **최초 호출** | `API-BPA-BCITT-S-GETCNTRINFO` | CNTR_NO, CNTR_SEQ로 컨테이너 정보 조회 |
| **조건부 호출** | `API-BPA-BCITT-S-GETBLOCKNUMBYTRKNO` | 블록 대기 차량 수 조회 |
| **조건부 호출** | `API-BPA-BCITT-S-GETPREINSPCOD` | 검사/세척완료 판단 시 |

**처리 흐름:**
```
processConLocationChange(tmnCode, cntrNo, cntrSeq, ...)
    ↓
API-BPA-BCITT-S-GETCNTRINFO (CNTR_NO, CNTR_SEQ로 조회)
    ↓
API-BPA-BCITT-S-GETBLOCKNUMBYTRKNO (블록 대기 차량 수)
    ↓
[분기] tmnCode == "H"
    ├─ cntrInsp=C/B && cleanYn=Y → "/vbs/terminal/EmptyConInspectionResult" (검사장→세척장)
    ├─ cntrInsp=B,D && typeBiz=P → "/vbs/terminal/EmptyConInspectionResult" (검사장→수리장)
    ├─ cntrInsp=B,D,S && typeBiz!=P
    │     ↓
    │     API-BPA-BCITT-S-GETPREINSPCOD (검사/세척완료 판단)
    │     ├─ 세척완료 → "/vbs/terminal/EmptyConCleaningResult"
    │     └─ 검사완료 → "/vbs/terminal/EmptyConInspectionResult"
    └─ else → "/vbs/terminal/ChangeConLoc"

[분기] tmnCode == "P"
    └─ "/vbs/terminal/ChangeConLoc"
```

---

### 5.9 EMTSWP↔MSG (공컨교체)

| 구분 | HMM Program ID | 설명 |
|------|----------------|------|
| **최초 호출** | `API-BPA-INFO-S-GETCNTRPININFO2` | prevCntrNo로 이전 컨테이너 정보 조회 |
| **추가 호출** | `API-BPA-INFO-S-GETCNTRPININFO3` | nextCntrNo로 다음 컨테이너 정보 조회 |
| **추가 호출** | `API-BPA-BCITT-S-GETBLOCKNUMBYTRKNO` | 블록 대기 차량 수 조회 |
| **후처리** | `API-BPA-BCITT-S-CRTAPPMNTMST` | 마스터 DB 업데이트 |

**처리 흐름:**
```
processEmptyConSwapResult(tmnCode, eirNo, truckNo, copinoId, prevCntrNo, nextCntrNo, msgDte)
    ↓
API-BPA-INFO-S-GETCNTRPININFO2 (prevCntrNo로 조회)
    ↓
API-BPA-INFO-S-GETCNTRPININFO3 (nextCntrNo로 조회)
    ↓
API-BPA-BCITT-S-GETBLOCKNUMBYTRKNO (블록 대기 차량 수)
    ↓
vbsBChainService.exchange("/vbs/terminal/EmptyConSwapResult")
    ↓
API-BPA-BCITT-S-CRTAPPMNTMST (마스터 DB 업데이트)
```

---

### 5.10 RF↔MSG (냉컨플러그아웃)

| 구분 | HMM Program ID | 설명 |
|------|----------------|------|
| **최초 호출** | `API-BPA-BCITT-S-GETCNTRINFO` | CNTR_NO, CNTR_SEQ로 컨테이너 정보 조회 |

**조건:**
- `type == "U" && newFinish == "Y" && oldCnlTag == "N"` 인 경우에만 처리

**처리 흐름:**
```
processReeferPlugInOutResult(tmnCode, cntrNo, cntrSeq, plugOrd)
    ↓
API-BPA-BCITT-S-GETCNTRINFO (CNTR_NO, CNTR_SEQ로 조회)
    ↓
vbsBChainService.exchange("/vbs/terminal/ReeferPlugInOutResult")
```

---

### 5.11 NONLOC↔MSG (장치 위치 없음)

| 구분 | HMM Program ID | 설명 |
|------|----------------|------|
| **최초 호출** | `API-BPA-INFO-S-GETCNTRPININFO` | CNTR_NO, CNTR_SEQ로 컨테이너 PIN 정보 조회 |

**처리 흐름:**
```
processNonConLocation(tmnCode, cntrNo, cntrSeq, cntrInsp, trkNo, msgDte)
    ↓
API-BPA-INFO-S-GETCNTRPININFO (CNTR_NO, CNTR_SEQ로 조회)
    ↓
vbsBChainService.exchange("/vbs/terminal/ChangeConLoc")
    ↓
(moveLoc = "ZZ", etcMessage = "자리 지정중")
```

---

## 6. HMM Program ID 요약

### 6.1 조회용 (GET/SELECT)

| Program ID | 용도 | 사용하는 메시지 |
|------------|------|----------------|
| `API-BPA-BCITT-S-GETCOPINOINFO` | MSG_SEQ로 코피노 정보 조회 | 코피노 검증, 코피노 삭제 |
| `API-BPA-BCITT-S-GETPINNO` | DOC_KEY로 PIN_NO 조회 | 코피노 삭제, 게이트 에러 |
| `API-BPA-BCITT-S-GETCNTRINFO` | CNTR_NO/SEQ로 컨테이너 정보 조회 | 작업위치변경, 냉컨플러그아웃 |
| `API-BPA-BCITT-S-GETBLOCKNUMBYTRKNO` | TRK_NO로 블록 대기 차량 수 조회 | 게이트 진입, 블록 진입, 작업위치변경, 공컨교체 |
| `API-BPA-BCITT-S-GETPREINSPCOD` | 검사/세척 이력 조회 | 작업위치변경 |
| `API-BPA-INFO-S-GETRFCNTRPLUGORD` | 냉동컨테이너 플러그 상태 조회 | 코피노 검증 |
| `API-BPA-INFO-S-GETCNTRPININFO` | CNTR_NO/SEQ로 PIN 정보 조회 | 장치 위치 없음 |
| `API-BPA-INFO-S-GETCNTRPININFO2` | prevCntrNo로 PIN 정보 조회 | 공컨교체 |
| `API-BPA-INFO-S-GETCNTRPININFO3` | nextCntrNo로 PIN 정보 조회 | 공컨교체 |
| `HITOPS3-WEB-BLK-S-GETITTINFOBYEIRNO` | EIR_NO로 ITT 정보 조회 (GateIn) | 게이트 진입 |
| `HITOPS3-WEB-BLK-S-GETITTINFOBYEIRNO2` | EIR_NO로 ITT 정보 조회 (GateOut) | 게이트 아웃 |
| `HITOPS3-WEB-BLK-S-GETITTINFOBYTRKNO` | TRK_NO로 ITT 정보 조회 | 게이트 에러, 블록 진입 |
| `HITOPS3-WEB-BLK-S-GETITTINFOBYJOBSEQ` | JOB_SEQ로 ITT 정보 조회 | 작업완료 |
| `HITOPS3-GTE-CMN-S-GETTRKBLKENTER` | JOB_SEQ로 블록 진입 정보 조회 | 블록 진입 |
| `HITOPS3-GTE-CTL-S-LSTXTCURRWORKSTATUS` | TRK_NO로 현재 작업 상태 조회 | PIN_NO 누락 예외처리 |

### 6.2 저장용 (CREATE/UPDATE)

| Program ID | 용도 | 사용하는 메시지 |
|------------|------|----------------|
| `API-BPA-BCITT-S-CRTAPPMNTMST` | 마스터 DB 업데이트 | 게이트 진입, 게이트 아웃, 작업완료, 코피노 삭제, 공컨교체 |
| `HITOPS3-WEB-BLK-S-CRTTRKDSTINFO` | 운송 완료상태 저장 | 게이트 아웃 |

---

## 7. 리팩토링 진행 현황

| 메시지 타입 | Handler | Integrator | Adapter | Sender | 상태 |
|------------|---------|------------|---------|--------|------|
| 코피노 검증 | ✅ | ✅ | ✅ | ✅ | 완료 |
| 코피노 삭제 | ✅ | ✅ | ✅ | ✅ | 완료 |
| 게이트 진입 | 🔄 | 🔄 | 🔄 | 🔄 | 진행중 |
| 게이트 아웃 | ⬜ | ⬜ | ⬜ | ⬜ | 미시작 |
| 게이트 에러 | ⬜ | ⬜ | ⬜ | ⬜ | 미시작 |
| 블록 진입 | ⬜ | ⬜ | ⬜ | ⬜ | 미시작 |
| 작업완료 | ⬜ | ⬜ | ⬜ | ⬜ | 미시작 |
| 작업위치변경 | ⬜ | ⬜ | ⬜ | ⬜ | 미시작 |
| 공컨교체 | ⬜ | ⬜ | ⬜ | ⬜ | 미시작 |
| 냉컨플러그아웃 | ⬜ | ⬜ | ⬜ | ⬜ | 미시작 |
| 장치 위치 없음 | ⬜ | ⬜ | ⬜ | ⬜ | 미시작 |

---

## 8. 참고사항

### 8.1 VBS/ITT 분기

레거시 코드에서는 VBS_YN, ITT_YN 플래그로 분기:
- `VBS_YN == "Y"` → VbsXxxService 호출
- `ITT_YN == "Y"` → IttXxxService 호출
- 둘 다 아닌 경우 → PIN_NO 누락 예외처리 후 VBS 처리

### 8.2 터미널 코드 분기

- `tmnCode == "H"` → HPNT (현대부두)
- `tmnCode == "P"` → PNIT (신선대부두)

### 8.3 게이트 취소 (CNL_TAG) 처리

GateOut 메시지에서 CNL_TAG=Y인 경우:
- XRAY=Y → CancelGate만 호출
- XRAY=N → CancelGate 후 GateOut 호출
