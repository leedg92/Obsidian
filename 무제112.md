완벽한 시나리오네요! 실전처럼 처음부터 끝까지 알려드리겠습니다.

## **환경 구성**

```
[VM1 - 외부서버]               [VM2 - 내부서버]
CentOS 7                       CentOS 7
인터넷 O                       인터넷 X
IP: 자동할당                   IP: 192.168.56.10 (예시)
역할: RPM 다운로드             역할: 실제 운영서버
```

---

## **Phase 1: 외부서버(VM1)에서 패키지 수집**

### **1-1. 필수 도구 설치**

```bash
# VM1에서 실행
sudo su -

# 도구 설치
yum install -y yum-utils createrepo

# 작업 디렉토리 생성
mkdir -p /tmp/httpd-local-repo
cd /tmp/httpd-local-repo
```

### **1-2. HTTPD 및 의존성 다운로드**

```bash
# 현재 디렉토리에 모든 RPM 다운로드
repotrack httpd httpd-tools mod_ssl

# 다운로드 확인
ls -lh
```

**예상 출력:**

```
apr-1.4.8-7.el7.x86_64.rpm
apr-util-1.5.2-6.el7.x86_64.rpm
httpd-2.4.6-99.el7.centos.1.x86_64.rpm
httpd-tools-2.4.6-99.el7.centos.1.x86_64.rpm
mailcap-2.1.41-2.el7.noarch.rpm
mod_ssl-2.4.6-99.el7.centos.1.x86_64.rpm
```

### **1-3. 저장소 메타데이터 생성**

```bash
# repodata 생성 (yum이 읽을 수 있는 형식)
createrepo .

# 결과 확인
ls -la
```

**예상 출력:**

```
drwxr-xr-x. 2 root root 4096 repodata/
-rw-r--r--. 1 root root xxxK apr-1.4.8-7.el7.x86_64.rpm
...
```

### **1-4. 압축 및 체크섬 생성**

```bash
# 상위 디렉토리로 이동
cd /tmp

# tar.gz로 압축
tar czf httpd-local-repo.tar.gz httpd-local-repo/

# 체크섬 생성 (전송 후 무결성 확인용)
sha256sum httpd-local-repo.tar.gz > httpd-local-repo.tar.gz.sha256

# 최종 확인
ls -lh httpd-local-repo.tar.gz*
```

**예상 출력:**

```
-rw-r--r--. 1 root root  15M httpd-local-repo.tar.gz
-rw-r--r--. 1 root root  89  httpd-local-repo.tar.gz.sha256
```

---

## **Phase 2: 파일 전송 (VM1 → VM2)**

### **방법 A: 공유 폴더 사용 (가장 쉬움)**

```bash
# VM1에서
# VirtualBox 공유폴더 설정 후
mkdir -p /mnt/shared
mount -t vboxsf share /mnt/shared

# 파일 복사
cp /tmp/httpd-local-repo.tar.gz* /mnt/shared/
```

```bash
# VM2에서
mkdir -p /mnt/shared
mount -t vboxsf share /mnt/shared

# 파일 가져오기
cp /mnt/shared/httpd-local-repo.tar.gz* /tmp/
```

### **방법 B: SCP 사용 (네트워크 연결 시)**

```bash
# VM1에서
scp /tmp/httpd-local-repo.tar.gz* root@192.168.56.10:/tmp/
```

### **방법 C: USB 시뮬레이션 (실전 환경)**

```bash
# VM1에서
# VirtualBox 메뉴: Devices → USB → USB 장치 선택

# USB 마운트
mkdir -p /mnt/usb
mount /dev/sdb1 /mnt/usb

# 파일 복사
cp /tmp/httpd-local-repo.tar.gz* /mnt/usb/
sync  # 버퍼 flush
umount /mnt/usb
```

```bash
# USB를 VM2로 연결 변경

# VM2에서
mkdir -p /mnt/usb
mount /dev/sdb1 /mnt/usb
cp /mnt/usb/httpd-local-repo.tar.gz* /tmp/
umount /mnt/usb
```

---

## **Phase 3: 내부서버(VM2)에서 저장소 구축**

### **3-1. 무결성 검증**

```bash
# VM2에서 실행
cd /tmp

# 체크섬 확인
sha256sum -c httpd-local-repo.tar.gz.sha256
```

**정상 출력:**

```
httpd-local-repo.tar.gz: OK
```

### **3-2. 압축 해제 및 배치**

```bash
# 압축 해제
tar xzf httpd-local-repo.tar.gz

# 영구 저장 위치로 이동
mkdir -p /var/yum-repos
mv httpd-local-repo /var/yum-repos/

# 권한 설정
chmod -R 755 /var/yum-repos/httpd-local-repo

# 구조 확인
tree /var/yum-repos/httpd-local-repo/ -L 1
```

**예상 출력:**

```
/var/yum-repos/httpd-local-repo/
├── apr-1.4.8-7.el7.x86_64.rpm
├── httpd-2.4.6-99.el7.centos.1.x86_64.rpm
├── repodata/
└── ...
```

### **3-3. 기존 저장소 비활성화 (중요!)**

```bash
# 기존 외부 저장소 비활성화
sed -i 's/enabled=1/enabled=0/g' /etc/yum.repos.d/CentOS-Base.repo

# 또는 백업 후 제거
mkdir -p /etc/yum.repos.d/backup
mv /etc/yum.repos.d/CentOS-*.repo /etc/yum.repos.d/backup/
```

### **3-4. 로컬 저장소 등록**

```bash
# 새 저장소 설정 파일 생성
cat > /etc/yum.repos.d/local-httpd.repo <<'EOF'
[local-httpd]
name=Local HTTPD Repository
baseurl=file:///var/yum-repos/httpd-local-repo
enabled=1
gpgcheck=0
priority=1
EOF

# 설정 확인
cat /etc/yum.repos.d/local-httpd.repo
```

### **3-5. Yum 캐시 초기화**

```bash
# 캐시 삭제
yum clean all

# 저장소 목록 확인
yum repolist
```

**정상 출력:**

```
Loaded plugins: fastestmirror
repo id              repo name                          status
local-httpd          Local HTTPD Repository             6
repolist: 6
```

### **3-6. 패키지 확인**

```bash
# httpd 패키지 검색
yum list available httpd

# 상세 정보 확인
yum info httpd
```

**예상 출력:**

```
Available Packages
Name        : httpd
Arch        : x86_64
Version     : 2.4.6
Release     : 99.el7.centos.1
Size        : 2.7 M
Repo        : local-httpd
```

---

## **Phase 4: HTTPD 설치 및 검증**

### **4-1. 기존 HTTPD 백업 (있다면)**

```bash
# 기존 설치 확인
rpm -qa | grep httpd

# 설치되어 있다면
systemctl stop httpd
cp -r /etc/httpd /etc/httpd.backup.$(date +%Y%m%d)
```

### **4-2. 설치 실행**

```bash
# httpd 및 mod_ssl 설치
yum install -y httpd mod_ssl httpd-tools

# 설치 확인
rpm -qa | grep httpd
```

**예상 출력:**

```
httpd-2.4.6-99.el7.centos.1.x86_64
httpd-tools-2.4.6-99.el7.centos.1.x86_64
mod_ssl-2.4.6-99.el7.centos.1.x86_64
```

### **4-3. 버전 확인**

```bash
# HTTPD 버전 확인
httpd -v

# 모듈 확인
httpd -M | grep ssl
```

**예상 출력:**

```
Server version: Apache/2.4.6 (CentOS)
Server built:   Nov  7 2023 09:30:23

 ssl_module (shared)
```

### **4-4. SSL 설정 확인**

```bash
# SSL 설정 파일 확인
ls -l /etc/httpd/conf.d/ssl.conf

# 문법 체크
httpd -t
```

**정상 출력:**

```
Syntax OK
```

### **4-5. 서비스 시작**

```bash
# 서비스 시작
systemctl start httpd

# 상태 확인
systemctl status httpd

# 자동 시작 설정
systemctl enable httpd

# 포트 확인
netstat -tlnp | grep httpd
```

**예상 출력:**

```
tcp6  0  0 :::80    :::*    LISTEN  1234/httpd
tcp6  0  0 :::443   :::*    LISTEN  1234/httpd
```

---

## **Phase 5: 최종 검증**

### **5-1. HTTP 테스트**

```bash
# 로컬 테스트
curl -I http://localhost

# 외부 접속 테스트 (VM 호스트에서)
curl -I http://192.168.56.10
```

### **5-2. SSL 테스트 (인증서 설정 후)**

```bash
# SSL 연결 테스트
openssl s_client -connect localhost:443 -showcerts

# 또는
curl -Ik https://localhost
```

### **5-3. 로그 확인**

```bash
# 에러 로그 확인
tail -f /var/log/httpd/error_log

# 액세스 로그 확인
tail -f /var/log/httpd/access_log
```

---

## **트러블슈팅 가이드**

### **문제 1: yum repolist에 저장소가 안 보임**

```bash
# 경로 확인
ls -la /var/yum-repos/httpd-local-repo/repodata/

# repodata 재생성
yum install createrepo -y  # 외부에서 받아온 경우
createrepo --update /var/yum-repos/httpd-local-repo/

# 캐시 삭제
rm -rf /var/cache/yum/*
yum clean all
yum repolist
```

### **문제 2: 의존성 오류**

```bash
# 누락된 패키지 확인
yum deplist httpd

# VM1에서 추가 다운로드
repotrack 누락된패키지명

# 다시 전송 및 repodata 갱신
```

### **문제 3: httpd 시작 실패**

```bash
# 상세 로그 확인
journalctl -xe -u httpd

# SELinux 문제일 경우
setenforce 0  # 임시
# 또는
setsebool -P httpd_can_network_connect 1

# 방화벽 확인
firewall-cmd --list-all
firewall-cmd --permanent --add-service=http
firewall-cmd --permanent --add-service=https
firewall-cmd --reload
```

---

## **체크리스트**

### **VM1 (외부서버) 완료 항목**

- [ ] yum-utils, createrepo 설치
- [ ] repotrack으로 RPM 다운로드
- [ ] createrepo로 메타데이터 생성
- [ ] tar.gz 압축
- [ ] sha256 체크섬 생성

### **전송 완료 항목**

- [ ] 파일 무결성 검증 (sha256sum)

### **VM2 (내부서버) 완료 항목**

- [ ] 압축 해제 및 /var/yum-repos로 이동
- [ ] 기존 저장소 비활성화
- [ ] local-httpd.repo 생성
- [ ] yum repolist 확인
- [ ] httpd 설치
- [ ] httpd -v 버전 확인
- [ ] systemctl start httpd
- [ ] 포트 80, 443 리스닝 확인

---

## **소요 시간 예상**

```
VM1 작업: 10-15분
파일 전송: 5-10분
VM2 작업: 10-15분
검증: 5분
총 소요: 약 30-45분
```

이 과정을 따라하시면 **완전히 격리된 내부망에서도 yum으로 httpd를 안전하게 설치**할 수 있습니다! 🚀